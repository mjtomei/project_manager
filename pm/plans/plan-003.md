# Multiuser Support

Support multiple users and processes safely accessing the same pm project state.

## PRs

### PR: Add file locking to project.yaml read-modify-write operations
- **description**: Add advisory file locking to `store.py` so that concurrent processes (TUI background sync, CLI commands, multiple users) cannot corrupt `project.yaml` with lost-update races. Introduce a `locked_update(root, fn)` context-manager or helper in `store.py` that acquires an `fcntl.flock` exclusive lock on a `project.yaml.lock` lockfile, calls `load()`, passes the data to `fn` which mutates and returns it, then calls `save()`, and finally releases the lock. All existing read-modify-write call sites (CLI commands in `cli/pr.py`, `cli/plan.py`, `cli/helpers.py`, TUI handlers in `tui/pr_view.py`, sync operations in `pr_sync.py` and `tui/sync.py`, guide steps in `guide.py`) must be migrated to use `locked_update` instead of bare `load()`/`save()` pairs. **Critical design constraint**: the lock must only be held during the actual file I/O and in-memory mutation — never across network calls. Operations that interleave GitHub API calls (e.g. `pr start` creating a draft PR, `pr done` calling `gh pr ready`, `sync_from_github` querying PR status) must be restructured to: (1) do the external call first without holding the lock, (2) acquire the lock, (3) load fresh state, (4) merge the external result into the fresh state, (5) save and release. This prevents a slow or hung GitHub call from blocking all other pm operations. The lock timeout should be short (e.g. 2 seconds) with a clear error message if acquisition fails, so users are never silently stuck. Read-only operations (`load()` without a subsequent `save()`) do not need locking.
- **tests**: Unit tests for `locked_update` — verify mutual exclusion (two threads, second blocks until first releases), verify timeout raises an error, verify the callback receives loaded data and save is called with the return value. Test that a concurrent writer during a slow callback gets correct final state (no lost updates). Integration test that runs two `pm pr edit` commands concurrently on different PRs and verifies both edits persist.
- **files**: pm_core/store.py, pm_core/cli/pr.py, pm_core/cli/plan.py, pm_core/cli/helpers.py, pm_core/tui/pr_view.py, pm_core/pr_sync.py, pm_core/tui/sync.py, pm_core/guide.py
- **depends_on**: Handle merging pm directory changes across clones

---

### PR: Add notes field to PRs for post-start addendums
- **description**: Add a `notes` list field to PR entries in `project.yaml` for recording addendums after work has begun. Each note has an `id` (hash-based, like PRs and plans — e.g. `note-a3f2b1c` generated from `sha256(text + timestamp)` truncated to 7 hex chars), `text`, and `added` timestamp (e.g. `{id: "note-a3f2b1c", text: "...", added: "2026-02-20T..."}`). Hash-based IDs avoid conflicts when multiple users add notes concurrently from different clones. Add `pm pr note <pr-id> <text>` CLI command to append a note to a PR, `pm pr note <pr-id> --list` to view existing notes, and `pm pr note <pr-id> --delete <note-id>` to remove a specific note by its hash ID. Notes must appear in: (1) the `pm pr edit` editor template as a simple bulleted list under a `# Notes (one per line, starting with -)` header — IDs and timestamps are hidden from the user, e.g. `- Fixed the API endpoint to use POST` — the parser diffs the edited list against existing notes to determine additions (new bullets get a fresh hash ID and timestamp), deletions (removed bullets are dropped), and edits (changed text gets a new hash ID and timestamp, treating it as a delete+add). Notes are always ordered by timestamp, newest at the bottom — there is no separate ordering field, (2) the detail panel in the TUI (`detail_panel.py`) below the description, (3) `prompt_gen.generate_prompt` as a "## Notes" section after the task description so Claude has the latest context, and (4) `prompt_gen.generate_review_prompt` so reviewers see addendums too. The `pm pr list` output should indicate when a PR has notes (e.g. a note count or icon).
- **tests**: Unit tests for note append, list, and delete operations on in-memory PR data. Test that `generate_prompt` and `generate_review_prompt` include notes when present and omit the section when empty. Test detail panel rendering with and without notes. Test `pm pr note` CLI command end-to-end with a temp project.yaml.
- **files**: pm_core/cli/pr.py, pm_core/prompt_gen.py, pm_core/tui/detail_panel.py, pm_core/cli/helpers.py
- **depends_on**:

---

### PR: Add TUI external control request protocol
- **description**: Add a formal mechanism for external processes to request and release control of the TUI, so that multiple users sharing a session don't have conflicting inputs. When `pm tui send` is called, it must first request control via `pm tui request-control -s <session>`, which posts a message to the TUI app. The TUI displays a prominent popup/modal giving the current user 3 seconds to deny the request (e.g. pressing any key or a specific deny key). If not denied, control is granted and the TUI enters "external control" mode: (1) the entire TUI border or background color changes to a distinct warning color (e.g. orange/yellow) to make it unmistakable that someone else is driving, (2) the status bar shows a persistent message like "EXTERNAL CONTROL (user@host)" with the identity of the controlling process, (3) local keypresses from the current user are either blocked or trigger a "reclaim control" action. The controlling process must release control via `pm tui release-control -s <session>` when done, which restores normal colors and input. Control also auto-expires after a configurable timeout (default 60s) to prevent orphaned locks. `pm tui send` is updated to require an active control grant — it refuses to send keys without one, printing an error directing the caller to request control first. Add `--force` flag to `pm tui send` for backward compatibility in scripts that don't need the protocol.
- **tests**: Test that `pm tui send` without control grant is rejected. Test that request-control popup appears and auto-grants after 3 seconds. Test that deny within 3 seconds rejects the request. Test that release-control restores normal mode. Test auto-expiry after timeout. Test that visual indicators (color, status message) change on grant and revert on release.
- **files**: pm_core/cli/tui.py, pm_core/tui/app.py, pm_core/tui/screens.py, pm_core/tui/widgets.py
- **depends_on**: Add multi-user support to sessions
